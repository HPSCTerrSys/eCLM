# Perturbation routines #

This section describes **perturbation capabilities for eCLM-PDAF**.

The implementation of the perturbation routines was first introduced
by Yorck Ewerdwalbesloh in
https://gitlab.jsc.fz-juelich.de/detect/cluster-c/c01/perturbationroutineclm5.

## Description

Temperature, precipitation as well as long and short wave radiation
are perturbed. The variables are correlated to each other to ensure
physical consistency (e.g. positive perturbation of incoming shortwave
radiation is related to a negative perturbation of longwave radiation
and a positive perturbation of temperature). For this, the same cross
correlations were used as in Reichle et al. (2007) and Han et
al. (2014). The perturbations are further correlated in space and in
time to ensure that it is still kind of "smooth" and does not look
like random noise. Spatial correlation between two grid cells was
generated by assuming an isotropic correlation structure depending on
the distance between the two grid points. The correlation distance was
set differently for precipitation than for the other variables as
precipitation is much more local (however, the values can be easily
adjusted).  The variables are also correlated temporal using a
first-order auto-regressive model following Evensen (2009). There the
temporal persistence was set so that the de-correlation time is 1 day
(again easily adjustable). The perturbation values are then read in
CLM5/eCLM and the variables are perturbed inside the model.

## Key Components ##

### 1. Soil Parameter Perturbation (`SoilStateInitTimeConstMod.F90`) ###

Allows reading perturbed hydraulic parameters from input files instead of computing them via pedotransfer functions.

**Parameters:**
- `THETAS` - saturated water content
- `SHAPE_PARAM` - Brooks-Corey shape parameter (`bsw`)
- `PSIS_SAT` - saturated matric potential (`sucsat`)
- `KSAT` - saturated hydraulic conductivity (`xksat`)

**Implementation:**
- Reads both original parameters (for `nlevsoifl=10` soil layers) and
  applies organic matter mixing
- OR: Reads adjusted parameters with `_adj` suffix (for all `nlevgrnd`
  layers) and **overwrites** parameters from organic matter mixing.
- Falls back to pedotransfer functions if parameters aren't in the file
- Modifies organic matter mixing to preserve perturbed parameter values

#### Note about the Brooks-Corey Shape Parameter ####

When perturbed soil parameters are read from input files, the organic
matter mixing for `bsw` uses the file-read value instead of the
hard-coded Cosby et al. (1984) Table 5 formula (`2.91 + 0.159*clay`).

### 2. Noise-Based Forcing Perturbation ###

When having an ensemble run, the memory consumption is too large if
the forcing data is perturbed one by one so that I get a file for each
month for each member idea: perturb the forcings in the CLM sourcecode
with a noise file.  for each perturbed variable (temperature,
precipitation, longwave and shortwave radiation), a stream is
introduced.

Adds spatiotemporal noise to atmospheric forcing data for ensemble
data assimilation.

**Modified files:**
- `shr_stream_mod.F90`
- `shr_strdata_mod.F90`
- `shr_dmodel_mod.F90`

**Key Features:**
- Stores ensemble metadata in stream structure:
  - `caseId` - ensemble member ID
  - `dt` - forcing time resolution
  - `numEns` - ensemble size that the perturbation file was created
    for. Example: Running with 50 ensemble members with a noise file
    created for an ensemble of up to 200 members. Then, `numEns`
    should be set to 200 in the stream file for right usage of
    perturbation dimension.
- **Time-shifting mechanism**: Different ensemble members read different temporal frames from the same noise file
  - Formula: `frame = nt + caseId * 24/dt`
  - Example: For 3-hourly data (`dt=3`), member 0 starts at frame
    `nt`, member 1 at `nt+8`, member 2 at `nt+16`, etc.
- Detects noise fields by checking if model field name contains `"noise"`
- Adjusts time coordinate reading to account for ensemble-extended noise files

### 3. DATM Integration (`datm_comp_mod.F90`) ###

Passes ensemble information (`inst_index`, `dt_option`, `ninst`) from
the data atmosphere (DATM) component to the stream infrastructure,
enabling the noise perturbation mechanism to operate correctly within
CESM's multi-instance framework.

## Design Rationale ##

1. **Dual perturbation approach**:
   - Parameter perturbation for soil properties (offline preprocessing)
   - Forcing perturbation via temporal noise patterns (runtime)

2. **Backward compatibility**: All changes are guarded by `USE_PDAF` preprocessor directives

3. **Efficiency**: Uses a single noise file for all ensemble members by time-shifting, avoiding storage duplication

4. **Flexibility**: Soil parameters can be perturbed or computed traditionally based on file contents

## Modified Source Code ##

- `src/clm5/biogeophys/SoilStateInitTimeConstMod.F90`
- `src/csm_share/streams/shr_stream_mod.F90`
- `src/csm_share/streams/shr_strdata_mod.F90`
- `src/csm_share/streams/shr_dmodel_mod.F90`
- `src/datm/datm_comp_mod.F90`

## Preparing atmospheric forcing noise

Information on how to prepare atmospherice forcing noise.

### Python script generating atmospheric forcing noise in NetCDF files

See `tools/correlatedNoise.py`.

Information on `correlatedNoise.py`:
- generates one noise file per month in which all ensemble members are considered, the number has to be specified
- accounts for correlations in space and time
- paths have to be adjusted
- dt has to be adjusted (3 for 3 hourly forcing data, 1 for 1 hourly forcing data,...)
- ds has to be adjusted (12.5 for 12.5 km grid, 3 for 3 km grid)
- nn could also be adjusted, major limiation: compute power (number of points which are used to generate noise, from those, the values are upscaled to the grid)
- rho could be adjusted depending on time resolution of forcings
- covariance fields and correlations can be adjusted


### Example stream files for atmospheric forcing noise ###

Three example streamfiles for noise are found in the following subsections. It is
important to specify the variables at the bottom

- timeInformation: which time resolution do the forcing files have for which the noise files are generated --> e.g. 3 for 3 hours
- caseId: caseId for the ensemble member that the noise is for --> e.g. 0 for the first ensemble member
- numEns: the number of ensemble members for which the perturbation file was generated
- variables for perturbation: tbot_noise, lwdn_noise, precn_noise, swdn_noise (temperaure, longwave radiation, precipitation, shortwave radiation)


#### user_datm.streams.precip_noise.stream_0000.txt ####

```xml
<dataSource>
   GENERIC
</dataSource>
<domainInfo>
  <variableNames>
     time    time
        xc      lon
        yc      lat
        area    area
        mask    mask
  </variableNames>
  <filePath>
     /path/to/domain/file
  </filePath>
  <fileNames>
     domain.lnd.EUR-11_EUR-11.230216_mask.nc
  </fileNames>
</domainInfo>
<fieldInfo>
   <variableNames>
     PRECTmms precn_noise
   </variableNames>
   <filePath>
     /path/to/noise/files
   </filePath>
   <fileNames>
2003-01.nc
2003-02.nc
2003-03.nc
2003-04.nc
2003-05.nc
2003-06.nc
2003-07.nc
2003-08.nc
2003-09.nc
2003-10.nc
2003-11.nc
2003-12.nc
   </fileNames>
   <offset>
     0 
   </offset>
   <timeInformation>
     3 
   </timeInformation>
   <caseId>
     0 
   </caseId>
   <numEns>
     64 
   </numEns>
</fieldInfo>
```

#### user_datm.streams.solar_noise.stream_0000.txt ####

```xml
<dataSource>
   GENERIC
</dataSource>
<domainInfo>
  <variableNames>
     time    time
        xc      lon
        yc      lat
        area    area
        mask    mask
  </variableNames>
  <filePath>
     /path/to/domain/file
  </filePath>
  <fileNames>
     domain.lnd.EUR-11_EUR-11.230216_mask.nc
  </fileNames>
</domainInfo>
<fieldInfo>
   <variableNames>
     FSDS swdn_noise
   </variableNames>
   <filePath>
     /path/to/noise/files
   </filePath>
   <fileNames>
2003-01.nc
2003-02.nc
2003-03.nc
2003-04.nc
2003-05.nc
2003-06.nc
2003-07.nc
2003-08.nc
2003-09.nc
2003-10.nc
2003-11.nc
2003-12.nc
   </fileNames>
   <offset>
     0 
   </offset>
   <timeInformation>
     3 
   </timeInformation>
   <caseId>
     0 
   </caseId>
   <numEns>
     64 
   </numEns>
</fieldInfo>
```

#### user_datm.streams.other_noise.stream_0000.txt ####

```xml
<dataSource>
   GENERIC
</dataSource>
<domainInfo>
  <variableNames>
     time    time
        xc      lon
        yc      lat
        area    area
        mask    mask
  </variableNames>
  <filePath>
     /path/to/domain/file
  </filePath>
  <fileNames>
     domain.lnd.EUR-11_EUR-11.230216_mask.nc
  </fileNames>
</domainInfo>
<fieldInfo>
   <variableNames>
        TBOT     tbot_noise
        FLDS     lwdn_noise
   </variableNames>
   <filePath>
     /path/to/noise/files
   </filePath>
   <fileNames>
2003-01.nc
2003-02.nc
2003-03.nc
2003-04.nc
2003-05.nc
2003-06.nc
2003-07.nc
2003-08.nc
2003-09.nc
2003-10.nc
2003-11.nc
2003-12.nc
   </fileNames>
   <offset>
     0 
   </offset>
   <timeInformation>
     3 
   </timeInformation>
   <caseId>
     0 
   </caseId>
   <numEns>
     64 
   </numEns>
</fieldInfo>

```
